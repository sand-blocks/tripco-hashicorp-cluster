job "nginx-loadbalancer" {
    datacenters = ["*"]
    type = "service"

    group "servers" {
        count = 3

        network {
            port "http" {
                static = 80
            }
        }

        service {
            name = "nginx-loadbalancer"
            port = "http"
        }

        task "nginx" {
            driver = "docker"

            config {
                image = "nginx:latest"
                ports = ["http"]
                volumes = ["local:/etc/nginx/conf.d"]
            
            }
            
          template {
    data = <<EOF
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=100m inactive=60m use_temp_path=off;

    upstream backend {
        {{ range service "webapp-backend" }}
        server {{ .Address }}:{{ .Port }};
        {{ end }} 
    }

    server {
        listen 80;

        location / {
            proxy_pass http://backend;
            # caching 
            proxy_cache my_cache;
            proxy_cache_valid 200 1m;
            proxy_cache_valid 404 1m;
            proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;
            add_header X-Proxy-Cache $upstream_cache_status;
        }
    }
    EOF

    destination = "local/nginx-lb.conf"
    change_mode = "signal"
    change_signal = "SIGHUP"
}
        }
    }
}